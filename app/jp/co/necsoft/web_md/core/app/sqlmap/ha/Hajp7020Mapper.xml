<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="jp.co.necsoft.web_md.core.app.sqlmap.ha.Hajp7020Mapper">
  <select id="selectHajp70201" parameterType="jp.co.necsoft.web_md.core.app.dto.ha.Hajp7020Param" resultType="jp.co.necsoft.web_md.core.app.dto.ha.Hajp7020Dto">
SELECT * FROM (SELECT 
SUBSTR(M009.TEN_CD, 5, 3) AS tenCd,
 M006.TEN_NM AS tenNm,
  ROUND(SUM(M009.JIDO_HAT_KIJUNSU - Z009.RRN_SU), 2) AS yoteSuryo,
  ROUND(SUM(M009.GENK * (M009.JIDO_HAT_KIJUNSU - Z009.RRN_SU)), 0) AS yoteKingaku
FROM (
  SELECT * FROM M009MSYM
  WHERE (TEN_CD, JAN_CD, HAKKO_DAY) IN (
    SELECT TEN_CD,JAN_CD, MAX(HAKKO_DAY)
    FROM M009MSYM
           WHERE
            <![CDATA[ 
            HAKKO_DAY <= #{unyoDate}
            AND HAKKO_DAY_TO >= #{unyoDate}
            ]]>
    GROUP BY TEN_CD, JAN_CD
  )
  AND ACT_KBN <![CDATA[ <> ]]> '9'
  <![CDATA[
  AND GENK >= 0
  ]]>
) M009
LEFT JOIN (<include refid="jp.co.necsoft.web_md.core.app.sqlmap.cm.CommonMapper.M006" />) M006
ON M009.TEN_CD = M006.TEN_CD
INNER JOIN Z009SHND Z009
  ON M009.JAN_CD = Z009.SHN_CD
  AND M009.TEN_CD = Z009.TEN_CD
  AND M009.JIDO_HAT_KIJUNSU >= Z009.RRN_SU
  AND Z009.UNY_DD = #{unyoDate}
WHERE
<![CDATA[ 
M009.HAKKO_DAY <= #{unyoDate}
AND M009.HAKKO_DAY_TO >= #{unyoDate}
]]>
AND M009.HAT_STOP = '1'
AND M009.AUTO_HAT_FLG = '1'
AND M009.ACT_KBN <![CDATA[ <> ]]> '9'
<![CDATA[ 
AND (M009.HACHU_TEISI_FROM > #{unyoDate}
OR M009.HACHU_TEISI_TO < #{unyoDate})
]]>
AND M009.DELETE_FLG = '0'
AND M009.TEN_CD LIKE #{kaisyaCd} || #{jigyobuCd} || '%'

group by M009.TEN_CD, M006.TEN_NM
ORDER BY M009.TEN_CD)
WHERE <![CDATA[ 
ROWNUM <= #{maxRecordNumber}
]]>
  </select>
  <select id="selectHajp70202" parameterType="jp.co.necsoft.web_md.core.app.dto.ha.Hajp7020Param" resultType="jp.co.necsoft.web_md.core.app.dto.ha.Hajp7020Dto">
SELECT * FROM (SELECT 
 SUBSTR(M009.TEN_CD, 5, 3) AS tenCd,
 M006.TEN_NM AS tenNm,
 M009.TRI_CD AS triCd,
 M011.TRI_NM AS triNm,
 ROUND(SUM(M009.JIDO_HAT_KIJUNSU - Z009.RRN_SU), 2) AS yoteSuryo,
 ROUND(SUM(M009.GENK * (M009.JIDO_HAT_KIJUNSU - Z009.RRN_SU)), 0) AS yoteKingaku
FROM (
  SELECT * FROM M009MSYM
  WHERE (TEN_CD, JAN_CD, HAKKO_DAY) IN (
    SELECT TEN_CD,JAN_CD, MAX(HAKKO_DAY)
    FROM M009MSYM
           WHERE
            <![CDATA[ 
            HAKKO_DAY <= #{unyoDate}
            AND HAKKO_DAY_TO >= #{unyoDate}
            ]]>
    GROUP BY TEN_CD, JAN_CD
  )
  AND ACT_KBN <![CDATA[ <> ]]> '9'
  <![CDATA[
  AND GENK >= 0
  ]]>
) M009
LEFT JOIN (<include refid="jp.co.necsoft.web_md.core.app.sqlmap.cm.CommonMapper.M006" />) M006
ON M009.TEN_CD = M006.TEN_CD
INNER JOIN Z009SHND Z009
  ON M009.JAN_CD = Z009.SHN_CD
  AND M009.TEN_CD = Z009.TEN_CD
  AND M009.JIDO_HAT_KIJUNSU >= Z009.RRN_SU
  AND Z009.UNY_DD = #{unyoDate}
LEFT JOIN (<include refid="jp.co.necsoft.web_md.core.app.sqlmap.cm.CommonMapper.M011" />) M011
ON M009.TRI_CD =  M011.TRI_CD
WHERE
<![CDATA[ 
M009.HAKKO_DAY <= #{unyoDate}
AND M009.HAKKO_DAY_TO >= #{unyoDate}
]]>
AND M009.HAT_STOP = '1'
AND M009.AUTO_HAT_FLG = '1'
AND M009.ACT_KBN <![CDATA[ <> ]]> '9'
<![CDATA[ 
AND (M009.HACHU_TEISI_FROM > #{unyoDate}
OR M009.HACHU_TEISI_TO < #{unyoDate})
]]>
AND M009.DELETE_FLG = '0'
AND M009.TEN_CD LIKE #{kaisyaCd} || #{jigyobuCd} || '%'
group by M009.TEN_CD, M006.TEN_NM, M009.TRI_CD, M011.TRI_NM
ORDER BY M009.TEN_CD)
WHERE <![CDATA[ 
ROWNUM <= #{maxRecordNumber}
]]>
  </select>
</mapper>